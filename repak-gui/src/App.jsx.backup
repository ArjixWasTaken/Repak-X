import { useState, useEffect } from 'react'
import { invoke } from '@tauri-apps/api/core'
import { open } from '@tauri-apps/plugin-dialog'
import { listen } from '@tauri-apps/api/event'
import './App.css'

function App() {
  const [gamePath, setGamePath] = useState('')
  const [mods, setMods] = useState([])
  const [folders, setFolders] = useState([])
  const [loading, setLoading] = useState(false)
  const [status, setStatus] = useState('')
  const [gameRunning, setGameRunning] = useState(false)
  const [version, setVersion] = useState('')

  useEffect(() => {
    loadInitialData()
    
    // Listen for install progress
    const unlisten = listen('install_progress', (event) => {
      setStatus(`Installing... ${Math.round(event.payload)}%`)
    })
    
    const unlistenComplete = listen('install_complete', () => {
      setStatus('Installation complete!')
      loadMods()
    })

    return () => {
      unlisten.then(fn => fn())
      unlistenComplete.then(fn => fn())
    }
  }, [])

  const loadInitialData = async () => {
    try {
      const path = await invoke('get_game_path')
      setGamePath(path)
      
      const ver = await invoke('get_app_version')
      setVersion(ver)
      
      await loadMods()
      await loadFolders()
      await checkGame()
    } catch (error) {
      console.error('Failed to load initial data:', error)
    }
  }

  const loadMods = async () => {
    try {
      const modList = await invoke('get_pak_files')
      setMods(modList)
    } catch (error) {
      setStatus('Error loading mods: ' + error)
    }
  }

  const loadFolders = async () => {
    try {
      const folderList = await invoke('get_folders')
      setFolders(folderList)
    } catch (error) {
      console.error('Failed to load folders:', error)
    }
  }

  const checkGame = async () => {
    try {
      const running = await invoke('check_game_running')
      setGameRunning(running)
    } catch (error) {
      console.error('Failed to check game status:', error)
    }
  }

  const handleAutoDetect = async () => {
    try {
      setLoading(true)
      const path = await invoke('auto_detect_game_path')
      setGamePath(path)
      setStatus('Game path detected: ' + path)
      await loadMods()
    } catch (error) {
      setStatus('Failed to auto-detect: ' + error)
    } finally {
      setLoading(false)
    }
  }

  const handleBrowseGamePath = async () => {
    try {
      const selected = await open({
        directory: true,
        multiple: false,
        title: 'Select Marvel Rivals Installation Directory'
      })
      
      if (selected) {
        await invoke('set_game_path', { path: selected })
        setGamePath(selected)
        setStatus('Game path set: ' + selected)
        await loadMods()
      }
    } catch (error) {
      setStatus('Error setting game path: ' + error)
    }
  }

  const handleDeleteMod = async (modPath) => {
    if (!confirm('Are you sure you want to delete this mod?')) return
    
    try {
      await invoke('delete_mod', { path: modPath })
      setStatus('Mod deleted')
      await loadMods()
    } catch (error) {
      setStatus('Error deleting mod: ' + error)
    }
  }

  const handleCreateFolder = async () => {
    const name = prompt('Enter folder name:')
    if (!name) return
    
    try {
      await invoke('create_folder', { name })
      await loadFolders()
      setStatus('Folder created')
    } catch (error) {
      setStatus('Error creating folder: ' + error)
    }
  }

  const handleDeleteFolder = async (folderId) => {
    if (!confirm('Delete this folder? Mods will not be deleted.')) return
    
    try {
      await invoke('delete_folder', { id: folderId })
      await loadFolders()
      setStatus('Folder deleted')
    } catch (error) {
      setStatus('Error deleting folder: ' + error)
    }
  }

  const formatFileSize = (bytes) => {
    if (bytes === 0) return '0 B'
    const k = 1024
    const sizes = ['B', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i]
  }

  return (
    <div className="app">
      <header className="header">
        <h1>üéÆ Repak Gui Revamped</h1>
        <span className="version">v{version}</span>
        {gameRunning && <span className="game-status">‚ö†Ô∏è Game Running</span>}
      </header>

      <div className="container">
        {/* Game Path Section */}
        <section className="section">
          <h2>Game Path</h2>
          <div className="path-controls">
            <input 
              type="text" 
              value={gamePath} 
              readOnly 
              placeholder="No game path set"
              className="path-input"
            />
            <button onClick={handleAutoDetect} disabled={loading}>
              Auto Detect
            </button>
            <button onClick={handleBrowseGamePath}>
              Browse
            </button>
          </div>
        </section>

        {/* Folders Section */}
        <section className="section">
          <div className="section-header">
            <h2>Folders</h2>
            <button onClick={handleCreateFolder} className="btn-small">
              + New Folder
            </button>
          </div>
          <div className="folder-list">
            {folders.length === 0 ? (
              <p className="empty-state">No folders created</p>
            ) : (
              folders.map(folder => (
                <div key={folder.id} className="folder-item">
                  <span className="folder-name">üìÅ {folder.name}</span>
                  <button 
                    onClick={() => handleDeleteFolder(folder.id)}
                    className="btn-danger-small"
                  >
                    Delete
                  </button>
                </div>
              ))
            )}
          </div>
        </section>

        {/* Mods Section */}
        <section className="section">
          <div className="section-header">
            <h2>Installed Mods ({mods.length})</h2>
            <button onClick={loadMods} className="btn-small">
              üîÑ Refresh
            </button>
          </div>
          <div className="mod-list">
            {mods.length === 0 ? (
              <p className="empty-state">No mods installed. Drop PAK files here to install.</p>
            ) : (
              mods.map((mod, idx) => (
                <div key={idx} className="mod-item">
                  <div className="mod-info">
                    <span className="mod-name">
                      {mod.custom_name || mod.path.split('\\').pop()}
                    </span>
                    <span className="mod-size">{formatFileSize(mod.file_size)}</span>
                  </div>
                  <div className="mod-actions">
                    {mod.custom_tags && mod.custom_tags.length > 0 && (
                      <span className="mod-tags">
                        {mod.custom_tags.join(', ')}
                      </span>
                    )}
                    <button 
                      onClick={() => handleDeleteMod(mod.path)}
                      className="btn-danger-small"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              ))
            )}
          </div>
        </section>

        {/* Status Bar */}
        {status && (
          <div className="status-bar">
            {status}
          </div>
        )}
      </div>

      <footer className="footer">
        <p>Drag & drop PAK files anywhere to install mods</p>
        <p className="footer-note">
          ‚ö†Ô∏è This is a barebones UI for testing. Full features: mod installation, 
          mesh fixing, texture patching, compression, IoStore packaging
        </p>
      </footer>
    </div>
  )
}

export default App
